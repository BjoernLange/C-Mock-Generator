# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

GTEST_SRC_DIR = /usr/src/gtest
GTEST_INCLUDE_DIR = /usr/include/gtest

# Points to the location of the Google Test libraries
GTEST_LIB_DIR = /usr/lib

# Where to find user code.
USER_PROJECT_DIR = .
USER_TEST_DIR = $(USER_PROJECT_DIR)/test
USER_SRC_DIR = $(USER_PROJECT_DIR)/src
USER_INCLUDE_DIR = $(USER_PROJECT_DIR)/include
MOCK_INCLUDE_DIR = $(USER_PROJECT_DIR)/mock/include
MOCK_SRC_DIR = $(USER_PROJECT_DIR)/mock/src
USER_INCLUDES = -I$(MOCK_INCLUDE_DIR) -I$(USER_INCLUDE_DIR)


# Flags passed to the preprocessor.
# Set Google Test's header directory as a system directory, such that
# the compiler doesn't generate warnings in Google Test headers.
CPPFLAGS += -isystem $(GTEST_INCLUDE_DIR)

# Flags passed to the C++ compiler.
CXXFLAGS += -g -Wall -Wextra -pthread -std=c++11

# Google Test libraries
GTEST_LIBS = libgtest.a libgtest_main.a

# All tests produced by this Makefile.
TESTS = application_test

# All Google Test headers.
GTEST_HEADERS = $(GTEST_INCLUDE_DIR)/*.h \
				$(GTEST_INCLUDE_DIR)/internal/*.h

# House-keeping build targets.

all : generate_mocks $(GTEST_LIBS) $(TESTS)

clean :
	rm -f $(GTEST_LIBS) $(TESTS) *.o;
	rm -rf mock


GTEST_SRCS_ = $(GTEST_SRC_DIR)/src/*.cc $(GTEST_SRC_DIR)/src/*.h $(GTEST_HEADERS)

gtest-all.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_SRC_DIR) $(CXXFLAGS) -c \
			$(GTEST_SRC_DIR)/src/gtest-all.cc

gtest_main.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_SRC_DIR) $(CXXFLAGS) -c \
			$(GTEST_SRC_DIR)/src/gtest_main.cc

libgtest.a : gtest-all.o
	$(AR) $(ARFLAGS) $@ $^

libgtest_main.a : gtest-all.o gtest_main.o
	$(AR) $(ARFLAGS) $@ $^

# Generate mocks
generate_mocks :
	mkdir mock;
	mkdir mock/include;
	mkdir mock/src;
	cd ../.. && python -m c_mock_generator.generate_mock \
		-i system_tests/complex/include/complex.h \
		-oh system_tests/complex/mock/include/complex.h \
		-oc system_tests/complex/mock/src/complex.c

# Build mocks
complex_mock.o : $(MOCK_SRC_DIR)/complex.c $(MOCK_INCLUDE_DIR)/complex.h $(GTEST_HEADERS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(USER_INCLUDES) -c $(MOCK_SRC_DIR)/complex.c -o complex_mock.o

# Build and run application tests
something.o : $(USER_SRC_DIR)/something.c $(USER_INCLUDE_DIR)/something.h $(GTEST_HEADERS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(USER_INCLUDES) -c $(USER_SRC_DIR)/something.c

something_test.o : $(USER_TEST_DIR)/something_test.c $(USER_INCLUDE_DIR)/something.h $(GTEST_HEADERS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(USER_INCLUDES) -c $(USER_TEST_DIR)/something_test.c

application_test : complex_mock.o something.o something_test.o $(GTEST_LIBS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -L$(GTEST_LIB_DIR) -lgtest_main -lpthread $^ -o $@
	./application_test
